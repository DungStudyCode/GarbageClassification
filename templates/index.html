<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống phân loại rác thải AI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>♻️ Phân loại rác thải bằng hình ảnh tích hợp AI ♻️</h1>
        
        <div class="tabs">
            <button class="tab-button active" onclick="showTab('upload-tab')">Tải ảnh lên</button>
            <button class="tab-button" onclick="showTab('camera-tab')">Sử dụng Camera</button>
        </div>

        <div id="upload-tab" class="tab-content active">
            <p>Vui lòng tải lên hình ảnh rác thải để hệ thống tự động phân loại.</p>
            <form method="post" enctype="multipart/form-data" id="upload-form">
                <input type="file" name="file" id="imageUpload" accept="image/*">
                <input type="submit" value="Phân loại (Upload)">
            </form>
            <div class="image-preview-container" id="uploadPreviewContainer" style="display: none;">
                <img id="imagePreview" src="#" alt="Xem trước ảnh">
            </div>
        </div>

        <div id="camera-tab" class="tab-content">
            <p>Đặt rác thải trước camera và nhấn "Chụp".</p>
            <div class="camera-controls">
                <button id="start-cam" class="button-cam-start">Bật Camera</button>
                <button id="stop-cam" class="button-cam-stop" style="display:none;">Tắt Camera</button>
            </div>
            
            <div class="video-container" id="video-wrapper" style="display:none;">
                <video id="webcam-feed" autoplay playsinline></video>
                <canvas id="canvas" style="display:none;"></canvas>
            </div>
            
            <button id="capture-cam" class="button-capture" style="display:none;">
                <span id="capture-text">Chụp và Phân loại (3)</span>
            </button>
        </div>

        {% with messages = get_flashed_messages() %}
            {% if messages %}
                <div class="flash-message">
                    {% for message in messages %}
                        <p>{{ message }}</p>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        {% if prediction %}
            <div class="result-wrapper">
                <h3>Kết quả phân loại:</h3>
                {% if uploaded_image_url %}
                <div class="image-preview-container" style="display: block;">
                    <img src="{{ uploaded_image_url }}" alt="Ảnh đã phân loại">
                </div>
                {% endif %}
                <div class="result" id="prediction-result">
                    <p>Loại rác được nhận diện: <strong>{{ prediction }}</strong></p>
                    <p>Độ tin cậy của mô hình: <strong>{{ confidence }}</strong></p>
                </div>
            </div>
        {% endif %}

        <div id="camera-result-wrapper" class="result-wrapper" style="display: none;">
            <h3>Kết quả phân loại (Camera):</h3>
            <div class="image-preview-container" id="capture-preview-container">
                <img id="capturePreview" src="#" alt="Ảnh đã chụp">
            </div>
            <div class="result" id="camera-prediction-result">
                </div>
            <div id="loading-spinner" class="spinner" style="display: none;"></div>
        </div>

    </div> 
    <script>
        // --- Logic cho Tab ---
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.currentTarget.classList.add('active');
            if (tabId === 'upload-tab') {
                stopCameraStream();
            }
        }

        // --- Logic cho Upload ---
        const imageUpload = document.getElementById('imageUpload');
        const imagePreview = document.getElementById('imagePreview');
        const uploadPreviewContainer = document.getElementById('uploadPreviewContainer');

        imageUpload.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    uploadPreviewContainer.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        // --- Logic cho Camera (Giữ nguyên) ---
        const startCamBtn = document.getElementById('start-cam');
        const stopCamBtn = document.getElementById('stop-cam');
        const captureCamBtn = document.getElementById('capture-cam');
        const videoWrapper = document.getElementById('video-wrapper');
        const videoElement = document.getElementById('webcam-feed');
        const canvasElement = document.getElementById('canvas');
        const capturePreview = document.getElementById('capturePreview');
        const capturePreviewContainer = document.getElementById('capture-preview-container');
        const cameraResultWrapper = document.getElementById('camera-result-wrapper');
        const cameraPredictionResult = document.getElementById('camera-prediction-result');
        const loadingSpinner = document.getElementById('loading-spinner');
        let stream = null;

        // 1. Bật Camera
        startCamBtn.addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
                videoElement.srcObject = stream;
                videoWrapper.style.display = 'block';
                startCamBtn.style.display = 'none';
                stopCamBtn.style.display = 'inline-block';
                captureCamBtn.style.display = 'inline-block';
                captureCamBtn.disabled = false;
                document.getElementById('capture-text').textContent = 'Chụp và Phân loại';
            } catch (err) { console.error("Lỗi mở camera: ", err); }
        });

        // 2. Tắt Camera
        function stopCameraStream() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                videoWrapper.style.display = 'none';
                startCamBtn.style.display = 'inline-block';
                stopCamBtn.style.display = 'none';
                captureCamBtn.style.display = 'none';
            }
        }
        stopCamBtn.addEventListener('click', stopCameraStream);

        // 3. Chụp ảnh (Giữ nguyên)
        captureCamBtn.addEventListener('click', () => {
            captureCamBtn.disabled = true; 
            loadingSpinner.style.display = 'block';
            cameraResultWrapper.style.display = 'none'; 
            let count = 3;
            const captureText = document.getElementById('capture-text');
            captureText.textContent = `Chụp trong... ${count}`;
            const countdown = setInterval(() => {
                count--;
                captureText.textContent = `Chụp trong... ${count}`;
                if (count === 0) {
                    clearInterval(countdown);
                    captureText.textContent = 'Đang xử lý...';
                    takePictureAndPredict();
                }
            }, 1000);
        });

        // 4. Lấy ảnh, Gửi đi VÀ PHÁT ÂM THANH
        async function takePictureAndPredict() {
            const context = canvasElement.getContext('2d');
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;
            context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
            const imageDataBase64 = canvasElement.toDataURL('image/jpeg');
            capturePreview.src = imageDataBase64;
            capturePreviewContainer.style.display = 'block';
            cameraResultWrapper.style.display = 'block';

            try {
                const response = await fetch('/predict_cam', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageDataBase64 }),
                });
                if (!response.ok) throw new Error(`Lỗi server: ${response.status}`);
                
                const result = await response.json();
                
                // Hiển thị kết quả (Như cũ)
                cameraPredictionResult.innerHTML = `
                    <p>Loại rác được nhận diện: <strong>${result.prediction}</strong></p>
                    <p>Độ tin cậy của mô hình: <strong>${result.confidence}</strong></p>
                `;

                // ==============================================
                // == CODE MỚI: PHÁT ÂM THANH TỪ SERVER (CAMERA) ==
                // ==============================================
                if (result.audio_url) {
                    const audio = new Audio(result.audio_url);
                    audio.play();
                }
                // ==============================================

            } catch (error) {
                console.error('Lỗi khi dự đoán:', error);
                cameraPredictionResult.innerHTML = `<p style="color: red;">Lỗi: ${error.message}</p>`;
            } finally {
                loadingSpinner.style.display = 'none';
                captureCamBtn.disabled = false;
                captureText.textContent = 'Chụp và Phân loại';
            }
        }

        // ==============================================
        // == CODE MỚI: PHÁT ÂM THANH KHI TẢI TRANG (CHO UPLOAD) ==
        // ==============================================
        document.addEventListener('DOMContentLoaded', (event) => {
            // Chúng ta cần lấy audio_url mà Flask đã render
            // Hãy thêm một thẻ ẩn vào HTML để chứa nó.
            
            // Tìm thẻ `prediction-result` (nơi chứa kết quả upload)
            const flaskResult = document.getElementById('prediction-result');
            
            // Lấy URL âm thanh từ template (Jinja2)
            // {{ audio_url }} sẽ được Flask render thành giá trị
            const audioUrlFromFlask = "{{ audio_url | default('None') }}"; 

            if (flaskResult && audioUrlFromFlask !== 'None') {
                try {
                    // Thêm độ trễ nhỏ để đảm bảo trang tải xong
                    setTimeout(() => {
                        const audio = new Audio(audioUrlFromFlask);
                        audio.play();
                    }, 300); // 300 mili-giây
                        
                } catch (e) {
                    console.error("Lỗi khi phát âm thanh upload: ", e);
                }
            }
        });
        // ==============================================
    </script>
</body>
</html>